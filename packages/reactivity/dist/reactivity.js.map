{
  "version": 3,
  "sources": ["../../shared/src/index.ts", "../src/effect.ts", "../src/reactiveEffect.ts", "../src/baseHandler.ts", "../src/reactive.ts"],
  "sourcesContent": ["export function isObject(value) {\r\n    return typeof value === 'object' && value !== null;\r\n}", "export function effect(fn, options = {}) {\r\n    // 1. \u521B\u5EFA\u54CD\u5E94\u5F0F\u7684 effect, \u6570\u636E\u53D8\u5316\u540E\u91CD\u65B0\u6267\u884C\r\n\r\n    // \u521B\u5EFA\u4E00\u4E2Aeffect\uFF0C\u53EA\u8981\u4F9D\u8D56\u5C5E\u6027\u53D8\u5316\uFF0C\u5C31\u4F1A\u91CD\u65B0\u6267\u884C\r\n    const _effect = new ReactiveEffect(fn, () => {\r\n        // scheduler\r\n        _effect.run()\r\n    });\r\n    _effect.run()\r\n\r\n    return _effect\r\n}\r\nexport let activeEffect;\r\nclass ReactiveEffect {\r\n    _trackId = 0; // \u7528\u4E8E\u8BB0\u5F55\u5F53\u524Deffect\u6267\u884C\u4E86\u51E0\u6B21\r\n    deps = [] // \u7528\u4E8E\u6536\u96C6\u4F9D\u8D56\r\n    _depsLength = 0 // \u7528\u4E8E\u8BB0\u5F55\u4F9D\u8D56\u7684\u957F\u5EA6\r\n\r\n    public active = true // \u521B\u5EFA\u7684effect\u662F\u54CD\u5E94\u5F0F\u7684\r\n    // fn \u7528\u6237\u7F16\u5199\u7684\u51FD\u6570\r\n    // \u5982\u679Cfn\u4E2D\u4F9D\u8D56\u7684\u6570\u636E\u53D1\u751F\u53D8\u5316\u540E\uFF0C \u9700\u8981\u91CD\u65B0\u8C03\u7528 -> run()\r\n    constructor(public fn, public scheduler) {\r\n\r\n    }\r\n\r\n    run() {\r\n\r\n        if (!this.active) {\r\n            // \u8BA9fn\u6267\u884C\r\n            return this.fn() // \u4E0D\u662F\u6FC0\u6D3B\u7684\uFF0C\u6267\u884C\u540E\u4EC0\u4E48\u90FD\u4E0D\u505A\r\n        }\r\n\r\n\r\n        let lastEffect = activeEffect\r\n        try {\r\n            activeEffect = this\r\n            // \u662F\u6FC0\u6D3B\u7684\uFF0C\u505A\u4F9D\u8D56\u624B\u673A\r\n            return this.fn()\r\n        } finally {\r\n            activeEffect = lastEffect\r\n        }\r\n    }\r\n}\r\n\r\nexport function trackEffects(effect, dep) {\r\n    dep.set(effect, effect._trackId)\r\n    // \u6211\u8FD8\u60F3\u8BA9effect\u548Cdep\u5173\u8054\u8D77\u6765\r\n    effect.deps[effect._depsLength++] = dep\r\n}\r\n\r\nexport function triggerEffects(dep) {\r\n    for (const effect of dep.keys()) {\r\n        if (effect.scheduler) {\r\n            effect.scheduler() // -> effect.run()\r\n        }\r\n    }\r\n}", "import { activeEffect, trackEffects, triggerEffects } from \"./effect\";\r\n\r\nconst targetMap = new WeakMap(); // \u5B58\u653E\u4F9D\u8D56\u6536\u96C6\u7684\u5173\u7CFB\u3001\r\n\r\nexport const createDep = (cleanup, key) => {\r\n    const dep = new Map() as any;\r\n    dep.cleanup = cleanup\r\n    dep.name = key\r\n    return dep\r\n}\r\n\r\nexport function track(target, key) {\r\n    if (activeEffect) {\r\n        let depsMap = targetMap.get(target)\r\n\r\n        if (!depsMap) {\r\n            targetMap.set(target, (depsMap = new Map()))\r\n        }\r\n\r\n        let dep = depsMap.get(key)\r\n\r\n        if (!dep) {\r\n            depsMap.set(key, dep = createDep(() => depsMap.delete(key), key)) // \u540E\u9762\u7528\u4E8E\u6E05\u7406\u4E0D\u9700\u8981\u7684\u5C5E\u6027\r\n        }\r\n\r\n\r\n        trackEffects(activeEffect, dep) // \u5C06\u5F53\u524D\u7684effect\u653E\u5230dep\u4E2D\uFF0C\u540E\u7EED\u53EF\u4EE5\u6839\u636E\u503C\u7684\u53D8\u5316\u89E6\u53D1\u6B64dep\u4E2D\u7684effect\r\n\r\n        console.log(targetMap)\r\n    }\r\n}\r\n\r\n\r\nexport function trigger(target, key, value, oldValue) {\r\n    const depsMap = targetMap.get(target)\r\n\r\n    if (!depsMap) { // \u627E\u4E0D\u5230\u5BF9\u8C61 === \u6CA1\u6536\u96C6\u4F9D\u8D56 \uFF0C\u76F4\u63A5return\r\n        return\r\n    }\r\n\r\n    let dep = depsMap.get(key)\r\n\r\n    if (dep) { // \u8BF4\u660E\u4FEE\u6539\u7684\u5C5E\u6027\u5BF9\u5E94\u4E86effect\r\n        triggerEffects(dep)\r\n    }\r\n}", "import { activeEffect } from \"./effect\"\r\nimport { track, trigger } from \"./reactiveEffect\"\r\n\r\nexport enum ReactiveFlags {\r\n    IS_REACTIVE = '__v_isReactive',\r\n}\r\n\r\nexport const mutableHandlers: ProxyHandler<any> = {\r\n    get(target, key, receiver) {\r\n        if (key === ReactiveFlags.IS_REACTIVE) {\r\n            return true\r\n        }\r\n\r\n        track(target, key) // \u6536\u96C6\u8FD9\u4E2A\u5BF9\u8C61\u4E0A\u7684\u5C5E\u6027\uFF0C\u548Ceffect\u5173\u8054\u5728\u4E00\u8D77\r\n\r\n        // \u5F53\u53D6\u503C\u7684\u65F6\u5019, \u5E94\u8BE5\u8BA9\u54CD\u5E94\u5F0F\u5C5E\u6027 \u548C effect \u6620\u5C04\u8D77\u6765\r\n        return Reflect.get(target, key, receiver)\r\n    },\r\n    set(target, key, value, receiver) {\r\n        // \u627E\u5230\u5C5E\u6027 \u8BA9\u90A3\u4E2A\u9875\u9762\u66F4\u65B0\r\n\r\n        let oldValue = target[key];\r\n        let result = Reflect.set(target, key, value, receiver)\r\n\r\n        // \u6BD4\u8F83\u65B0\u65E7\u503C\r\n        if (oldValue !== value) {\r\n            // \u9700\u8981\u89E6\u53D1\u66F4\u65B0\r\n            trigger(target, key, value, oldValue)\r\n        }\r\n\r\n        return result\r\n    }\r\n}", "import { isObject } from \"@vue/shared\";\r\nimport { mutableHandlers, ReactiveFlags } from \"./baseHandler\";\r\n\r\n// \u7528\u4E8E\u8BB0\u5F55\u6211\u4EEC \u4EE3\u7406\u540E\u7684\u7ED3\u679C\r\nconst reactiveMap = new WeakMap();\r\n\r\nfunction createReactiveObject(target) {\r\n    // \u7EDF\u4E00\u505A\u5224\u65AD,\u54CD\u5E94\u5F0F\u5BF9\u8C61\u5FC5\u987B\u662F\u5BF9\u8C61\u624D\u53EF\u4EE5\r\n    if (!isObject(target)) {\r\n        return target;\r\n    }\r\n\r\n    if (target[ReactiveFlags.IS_REACTIVE]) {\r\n        console.log(target[ReactiveFlags.IS_REACTIVE])\r\n        return target\r\n    }\r\n\r\n    const existsProxy = reactiveMap.get(target);\r\n\r\n    // \u53D6\u7F13\u5B58 \u5982\u679C\u5B58\u5728\u76F4\u63A5\u8FD4\u56DE\r\n    if (existsProxy) {\r\n        return existsProxy\r\n    }\r\n\r\n    let proxy = new Proxy(target, mutableHandlers);\r\n    console.log(\"\uD83D\uDE80 ~ createReactiveObject ~ proxy:\", proxy[ReactiveFlags.IS_REACTIVE])\r\n    reactiveMap.set(target, proxy)\r\n    return proxy\r\n}\r\n\r\n// reactive shallowReactive\r\nexport function reactive(target) {\r\n    return createReactiveObject(target);\r\n}\r\n"],
  "mappings": "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",
  "names": ["effect"]
}
